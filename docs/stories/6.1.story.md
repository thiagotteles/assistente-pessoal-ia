# Story 6.1: Templates e Gerador de Comandos Cursor

**ID:** STORY-6.1
**Epic:** [Epic 6 - Suporte ao Cursor IDE](../epics/epic-6.md)
**Status:** Planejado
**Prioridade:** Alta
**Estimativa:** 4 horas

---

## Descrição

Criar templates de comandos Cursor e implementar gerador automático que transforma agentes do `.assistant-core/` em comandos flat para `.cursor/commands/`.

## Contexto

Cursor não suporta estrutura hierárquica de comandos. Precisamos gerar dois tipos:
1. **Comando Base**: Agente conversacional completo
2. **Comandos Específicos**: Atalhos diretos para tasks principais

## Objetivos

- Criar template de comando base Cursor
- Criar template de comando específico (task)
- Implementar gerador automático
- Criar regras globais `.cursor/rules/`
- Validar geração para os 5 agentes

---

## Histórias de Usuário

**Como** desenvolvedor do sistema
**Quero** gerar comandos Cursor automaticamente
**Para** não ter que criar/manter manualmente 20+ arquivos

**Critérios de Aceitação:**
- [ ] Template `cursor-agent-base.template.md` criado
- [ ] Template `cursor-task-specific.template.md` criado
- [ ] Função `generateCursorCommands(agent)` implementada
- [ ] Regras globais `.cursor/rules/assistente-core.md` criadas
- [ ] Geração testada para organizador e secretaria

---

## Especificação Técnica

### 1. Template: Comando Base

**Arquivo:** `templates/cursor-agent-base.template.md`

```markdown
# {{AGENT_NAME}} - {{AGENT_TITLE}}

Você é **{{AGENT_NAME}}**, {{AGENT_DESCRIPTION}}.

## Sua Persona

{{AGENT_PERSONA}}

## Comandos Disponíveis

O usuário pode pedir as seguintes ações em linguagem natural:

{{#each COMMANDS}}
- "{{this.trigger}}" → Execute a task `{{this.taskFile}}`
{{/each}}

## Como Funcionar

1. Quando o usuário pedir uma ação, identifique qual task executar
2. Leia o arquivo `.assistant-core/tasks/{{taskFile}}`
3. Siga as instruções da task EXATAMENTE como escritas
4. Mantenha sua persona {{AGENT_NAME}} durante toda interação

## Regras Importantes

- SEMPRE use português brasileiro
- Seja {{STYLE}}
- Máximo 3 perguntas por vez (evitar overwhelm TDAH)
- Use [[wikilinks]] para referências internas
- Salve em `knowledge-base/` quando apropriado

## Estrutura do Projeto

- `despejo/daily-dump.md`: Despejo mental diário
- `knowledge-base/`: Base de conhecimento organizada
  - `projetos/`: Projetos do usuário
  - `pessoas/`: Contatos e relacionamentos
  - `reunioes/`: Notas de reuniões
  - `decisoes/`: Decisões técnicas/pessoais
- `todos/central-todos.md`: Lista central de tarefas
- `.assistant-core/tasks/`: Tasks que você pode executar

---

*Gerado automaticamente pelo Assistente Pessoal IA v{{VERSION}}*
```

### 2. Template: Comando Específico

**Arquivo:** `templates/cursor-task-specific.template.md`

```markdown
# {{AGENT_NAME}}: {{TASK_TITLE}}

Execute imediatamente a task **{{TASK_FILE}}** como o agente **{{AGENT_NAME}}**.

## Instruções

1. Assuma a persona de {{AGENT_NAME}}: {{AGENT_DESCRIPTION}}
2. Leia `.assistant-core/tasks/{{TASK_FILE}}`
3. Execute as instruções EXATAMENTE como escritas
4. Mantenha tom {{STYLE}} em português brasileiro

## Contexto do Projeto

{{PROJECT_STRUCTURE}}

## Task a Executar

**Arquivo:** `.assistant-core/tasks/{{TASK_FILE}}`

{{TASK_DESCRIPTION}}

---

*Este é um atalho direto. Para modo conversacional, use `/{{AGENT_ID}}`*
```

### 3. Gerador de Comandos

**Arquivo:** `src/installer/cursor-command-generator.js`

```javascript
const fs = require('fs-extra');
const path = require('path');
const Handlebars = require('handlebars');
const agentRegistry = require('../utils/agent-registry');

class CursorCommandGenerator {
  constructor() {
    this.templatesDir = path.join(__dirname, '../../templates');
    this.baseTemplate = null;
    this.taskTemplate = null;
  }

  /**
   * Load templates
   */
  async loadTemplates() {
    const basePath = path.join(this.templatesDir, 'cursor-agent-base.template.md');
    const taskPath = path.join(this.templatesDir, 'cursor-task-specific.template.md');

    const baseContent = await fs.readFile(basePath, 'utf-8');
    const taskContent = await fs.readFile(taskPath, 'utf-8');

    this.baseTemplate = Handlebars.compile(baseContent);
    this.taskTemplate = Handlebars.compile(taskContent);
  }

  /**
   * Generate all commands for an agent
   */
  async generateAgentCommands(agentId) {
    const agent = agentRegistry.getAgent(agentId);
    if (!agent) {
      throw new Error(`Agent ${agentId} not found`);
    }

    const commands = [];

    // 1. Base command (conversational)
    commands.push({
      filename: `${agentId}.md`,
      content: await this.generateBaseCommand(agent)
    });

    // 2. Specific task commands
    const specificCommands = await this.generateTaskCommands(agent);
    commands.push(...specificCommands);

    return commands;
  }

  /**
   * Generate base conversational command
   */
  async generateBaseCommand(agent) {
    // Read agent source
    const agentSource = path.join(__dirname, '../../.assistant-core/agents', `${agent.id}.md`);
    const agentContent = await fs.readFile(agentSource, 'utf-8');

    // Extract YAML block
    const yaml = this.extractYAML(agentContent);

    // Map commands to triggers
    const commands = this.mapCommandsToTriggers(agent, yaml);

    return this.baseTemplate({
      AGENT_NAME: agent.name,
      AGENT_ID: agent.id,
      AGENT_TITLE: agent.title || agent.name,
      AGENT_DESCRIPTION: agent.description,
      AGENT_PERSONA: this.extractPersona(yaml),
      STYLE: this.extractStyle(yaml),
      COMMANDS: commands,
      PROJECT_STRUCTURE: this.getProjectStructure(),
      VERSION: require('../../package.json').version
    });
  }

  /**
   * Generate task-specific commands
   */
  async generateTaskCommands(agent) {
    const commands = [];

    // Get main tasks (top 3-5 most used)
    const mainTasks = this.getMainTasks(agent);

    for (const task of mainTasks) {
      const content = this.taskTemplate({
        AGENT_NAME: agent.name,
        AGENT_ID: agent.id,
        AGENT_DESCRIPTION: agent.description,
        STYLE: agent.style || 'empático e estruturado',
        TASK_TITLE: task.title,
        TASK_FILE: task.file,
        TASK_DESCRIPTION: task.description,
        PROJECT_STRUCTURE: this.getProjectStructure()
      });

      commands.push({
        filename: `${agent.id}-${task.id}.md`,
        content
      });
    }

    return commands;
  }

  /**
   * Extract YAML block from agent markdown
   */
  extractYAML(content) {
    const match = content.match(/```yaml\n([\s\S]*?)\n```/);
    if (!match) return {};

    // Parse YAML (simplified - usar biblioteca yaml se necessário)
    const yamlContent = match[1];
    return this.parseYAMLSimple(yamlContent);
  }

  /**
   * Simple YAML parser (básico)
   */
  parseYAMLSimple(yaml) {
    // TODO: Usar biblioteca 'yaml' se estrutura complexa
    const lines = yaml.split('\n');
    const result = {};

    lines.forEach(line => {
      if (line.includes(':')) {
        const [key, value] = line.split(':').map(s => s.trim());
        result[key] = value;
      }
    });

    return result;
  }

  /**
   * Map commands to natural language triggers
   */
  mapCommandsToTriggers(agent, yaml) {
    const mapping = {
      'organizador': [
        { trigger: 'processa meu despejo', taskFile: 'processar-despejo.md', id: 'processar' },
        { trigger: 'organiza por projeto', taskFile: 'organizar-por-projeto.md', id: 'organizar' },
        { trigger: 'revisa pendências', taskFile: 'revisar-pendencias.md', id: 'revisar' }
      ],
      'secretaria': [
        { trigger: 'agenda do dia', taskFile: 'agenda-do-dia.md', id: 'agenda' },
        { trigger: 'registra reunião', taskFile: 'registro-reuniao.md', id: 'reuniao' },
        { trigger: 'status dos projetos', taskFile: 'status-projetos.md', id: 'status' }
      ],
      'arquiteto': [
        { trigger: 'consultoria técnica', taskFile: 'consultoria-tecnica.md', id: 'consulta' },
        { trigger: 'analisa projeto', taskFile: 'analise-projeto.md', id: 'analise' },
        { trigger: 'registra decisão', taskFile: 'registrar-decisao.md', id: 'decisao' }
      ],
      'psicologo': [
        { trigger: 'suporte emocional', taskFile: 'suporte-emocional.md', id: 'suporte' },
        { trigger: 'detecta procrastinação', taskFile: 'detectar-procrastinacao.md', id: 'procrastinacao' },
        { trigger: 'sugere técnicas', taskFile: 'sugerir-tecnicas.md', id: 'tecnicas' }
      ],
      'mentor': [
        { trigger: 'identifica oportunidades', taskFile: 'identificar-oportunidades.md', id: 'oportunidades' },
        { trigger: 'prepara conversa', taskFile: 'preparar-conversa.md', id: 'conversa' },
        { trigger: 'tracking de metas', taskFile: 'tracking-metas.md', id: 'metas' }
      ]
    };

    return mapping[agent.id] || [];
  }

  /**
   * Get main tasks for an agent
   */
  getMainTasks(agent) {
    const mapping = this.mapCommandsToTriggers(agent, {});
    return mapping.map(cmd => ({
      id: cmd.id,
      title: cmd.trigger,
      file: cmd.taskFile,
      description: `Execute ${cmd.taskFile}`
    }));
  }

  /**
   * Extract persona from YAML
   */
  extractPersona(yaml) {
    return yaml.role || 'Assistente IA especializado';
  }

  /**
   * Extract style from YAML
   */
  extractStyle(yaml) {
    return yaml.style || 'profissional e prestativo';
  }

  /**
   * Get project structure description
   */
  getProjectStructure() {
    return `
- \`despejo/daily-dump.md\`: Despejo mental diário
- \`knowledge-base/\`: Base de conhecimento organizada
- \`todos/central-todos.md\`: Lista central de tarefas
- \`.assistant-core/tasks/\`: Tasks compartilhadas
    `.trim();
  }
}

module.exports = CursorCommandGenerator;
```

### 4. Cursor Rules

**Arquivo:** `templates/cursor-rules-assistente-core.md`

```markdown
# Assistente Pessoal IA - Regras Globais

## Estrutura do Projeto

Este projeto usa o Assistente Pessoal IA com 5 agentes especializados:

- **Sofia** (Organizador): Processa despejos mentais e organiza informações
- **Secretária**: Gerencia agenda, reuniões e status de projetos
- **Marcus** (Arquiteto): Consultoria técnica e decisões arquiteturais
- **Dr. Silva** (Psicólogo): Suporte emocional e técnicas para TDAH
- **Carlos** (Mentor): Crescimento de carreira e networking

## Pastas Importantes

```
despejo/
  daily-dump.md           # Despejo mental diário (input principal)

knowledge-base/
  projetos/               # Projetos ativos
  pessoas/                # Contatos e relacionamentos
  reunioes/               # Notas de reuniões
  decisoes/               # Decisões importantes
  aprendizados/           # Learnings e insights

todos/
  central-todos.md        # Lista central de tarefas

.assistant-core/
  tasks/                  # Tasks compartilhadas (23 tasks)
  agents/                 # Definições dos agentes
```

## Comportamento dos Agentes

Quando assumir qualquer agente:

1. **Leia tasks de** `.assistant-core/tasks/`
2. **Siga instruções EXATAMENTE** como escritas
3. **Use português brasileiro** sempre
4. **Máximo 3 perguntas** por interação (evitar sobrecarga TDAH)
5. **Use [[wikilinks]]** para referenciar arquivos
6. **Salve em** `knowledge-base/` categorias apropriadas
7. **Mantenha tom empático** e estruturado

## Formato de Referências

```markdown
[[projetos/nome-do-projeto]]
[[pessoas/nome-da-pessoa]]
[[decisoes/titulo-da-decisao]]
```

## Tasks Disponíveis

Execute tasks lendo de `.assistant-core/tasks/{nome-da-task}.md`

Exemplos:
- `processar-despejo.md` - Organiza daily-dump.md
- `organizar-por-projeto.md` - Visualiza info por projeto
- `agenda-do-dia.md` - Prepara agenda do dia
- `suporte-emocional.md` - Oferece suporte TDAH

## Prioridades

1. **Bem-estar emocional** > eficiência
2. **Urgência real** > urgência percebida
3. **Clareza** > completude
4. **Progresso** > perfeição

## Nunca Faça

- ❌ Mais de 3 perguntas de uma vez
- ❌ Linguagem técnica ou robótica
- ❌ Julgar procrastinação ou desorganização
- ❌ Criar tasks sem consenso do usuário
- ❌ Ignorar padrões TDAH do usuário

---

*Regras do Assistente Pessoal IA - Aplicadas a todos os agentes*
```

---

## Testes

### Teste 1: Geração de Comando Base

```javascript
// test/cursor-generator.test.js
const generator = new CursorCommandGenerator();

test('Generate base command for organizador', async () => {
  await generator.loadTemplates();
  const commands = await generator.generateAgentCommands('organizador');

  expect(commands).toHaveLength(4); // 1 base + 3 specific
  expect(commands[0].filename).toBe('organizador.md');
  expect(commands[0].content).toContain('Sofia');
  expect(commands[0].content).toContain('processa meu despejo');
});
```

### Teste 2: Validação de Templates

```bash
# Validar se templates têm variáveis corretas
grep -o "{{[^}]*}}" templates/cursor-agent-base.template.md
# Deve retornar: AGENT_NAME, AGENT_ID, COMMANDS, etc.
```

### Teste 3: Geração Completa

```bash
# Gerar comandos para todos agentes
node scripts/generate-cursor-commands.js

# Validar que foram criados
ls .cursor/commands/
# Deve ter: 5 agentes base + ~15 específicos = 20 arquivos
```

---

## Critérios de Aceitação

- [ ] Template `cursor-agent-base.template.md` criado e testado
- [ ] Template `cursor-task-specific.template.md` criado e testado
- [ ] Classe `CursorCommandGenerator` implementada
- [ ] Função `generateAgentCommands()` funcional
- [ ] Geração testada para organizador retorna 4 comandos
- [ ] Geração testada para secretaria retorna 4 comandos
- [ ] Arquivo `.cursor/rules/assistente-core.md` criado
- [ ] Documentação da classe no código
- [ ] Testes unitários passando

---

## Notas de Implementação

### Dependências Necessárias

```bash
npm install handlebars yaml --save
```

### Estrutura de Teste

```
test/
  cursor-command-generator.test.js
  fixtures/
    organizador.md
    expected-organizador-base.md
    expected-organizador-processar.md
```

---

**Próxima Story:** [6.2 - Instalador Dual-IDE](./6.2.story.md)
