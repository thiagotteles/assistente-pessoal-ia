# Story 6.2: Instalador Dual-IDE

**ID:** STORY-6.2
**Epic:** [Epic 6 - Suporte ao Cursor IDE](../epics/epic-6.md)
**Status:** Planejado
**Prioridade:** Alta
**Estimativa:** 4 horas
**Depende de:** Story 6.1

---

## DescriÃ§Ã£o

Modificar o instalador para detectar automaticamente IDEs instalados (Claude Code e/ou Cursor) e permitir ao usuÃ¡rio escolher onde instalar os agentes.

## Objetivos

- Detectar Claude Code instalado
- Detectar Cursor instalado
- Perguntar "Para qual IDE instalar?"
- Instalar estrutura otimizada para cada IDE
- Suportar instalaÃ§Ã£o em ambos simultaneamente

---

## ImplementaÃ§Ã£o

### 1. DetecÃ§Ã£o de IDEs

**Arquivo:** `src/utils/ide-detector.js`

```javascript
const fs = require('fs-extra');
const { exec } = require('child_process');
const os = require('os');
const path = require('path');

class IDEDetector {
  /**
   * Detect which IDEs are installed
   */
  async detectInstalledIDEs() {
    const ides = {
      claudeCode: await this.isClaudeCodeInstalled(),
      cursor: await this.isCursorInstalled()
    };

    return ides;
  }

  /**
   * Check if Claude Code is installed
   */
  async isClaudeCodeInstalled() {
    try {
      // Check if command exists
      return new Promise((resolve) => {
        exec('claude-code --version', (error) => {
          resolve(!error);
        });
      });
    } catch {
      return false;
    }
  }

  /**
   * Check if Cursor is installed
   */
  async isCursorInstalled() {
    const platform = os.platform();

    try {
      if (platform === 'darwin') {
        // macOS
        return await fs.pathExists('/Applications/Cursor.app');
      } else if (platform === 'win32') {
        // Windows
        const localAppData = process.env.LOCALAPPDATA;
        const cursorPath = path.join(localAppData, 'Programs', 'cursor');
        return await fs.pathExists(cursorPath);
      } else {
        // Linux
        return new Promise((resolve) => {
          exec('which cursor', (error) => {
            resolve(!error);
          });
        });
      }
    } catch {
      return false;
    }
  }

  /**
   * Get list of available IDEs with labels
   */
  async getAvailableIDEs() {
    const installed = await this.detectInstalledIDEs();
    const options = [];

    if (installed.claudeCode) {
      options.push({
        name: 'Claude Code (Anthropic)',
        value: 'claude-code',
        checked: true
      });
    }

    if (installed.cursor) {
      options.push({
        name: 'Cursor (VS Code-based)',
        value: 'cursor',
        checked: true
      });
    }

    if (options.length === 0) {
      options.push({
        name: 'Claude Code (instalar manualmente)',
        value: 'claude-code',
        checked: true
      });
      options.push({
        name: 'Cursor (instalar manualmente)',
        value: 'cursor',
        checked: false
      });
    }

    return options;
  }
}

module.exports = IDEDetector;
```

### 2. Prompts Atualizados

**Arquivo:** `src/installer/prompts.js` (modificar)

```javascript
const IDEDetector = require('../utils/ide-detector');

async promptIDESelection() {
  const detector = new IDEDetector();
  const availableIDEs = await detector.getAvailableIDEs();

  console.log(chalk.blue('\nðŸ–¥ï¸  Detectando IDEs instalados...\n'));

  const { selectedIDEs } = await inquirer.prompt([
    {
      type: 'checkbox',
      name: 'selectedIDEs',
      message: 'Para qual(is) IDE(s) deseja instalar os agentes?',
      choices: availableIDEs,
      validate: (answer) => {
        if (answer.length < 1) {
          return 'Selecione pelo menos um IDE!';
        }
        return true;
      }
    }
  ]);

  console.log(chalk.gray(`\nIDEs selecionados: ${selectedIDEs.join(', ')}\n`));

  return {
    installClaudeCode: selectedIDEs.includes('claude-code'),
    installCursor: selectedIDEs.includes('cursor')
  };
}
```

### 3. Setup Modificado

**Arquivo:** `src/installer/setup.js` (adicionar)

```javascript
const CursorCommandGenerator = require('./cursor-command-generator');

/**
 * Install agents based on selected IDEs
 */
async installAgentsForIDEs() {
  const { installClaudeCode, installCursor } = this.preferences;

  if (installClaudeCode) {
    await this.installForClaudeCode();
  }

  if (installCursor) {
    await this.installForCursor();
  }
}

/**
 * Install for Claude Code (estrutura atual)
 */
async installForClaudeCode() {
  const spinner = ora('Instalando para Claude Code...').start();

  try {
    const agentsDir = path.join(
      this.installPath,
      '.claude', 'commands', 'assistentes', 'agents'
    );
    const tasksDir = path.join(
      this.installPath,
      '.claude', 'commands', 'assistentes', 'tasks'
    );

    await fs.ensureDir(agentsDir);
    await fs.ensureDir(tasksDir);

    // Copiar agentes selecionados
    for (const agentId of this.selectedAgents) {
      const source = path.join(__dirname, '../../.assistant-core/agents', `${agentId}.md`);
      const target = path.join(agentsDir, `${agentId}.md`);

      if (await fs.pathExists(source)) {
        await fs.copy(source, target, { overwrite: true });
      }
    }

    // Copiar todas as tasks
    const tasksSource = path.join(__dirname, '../../.assistant-core/tasks');
    if (await fs.pathExists(tasksSource)) {
      const tasks = await fs.readdir(tasksSource);

      for (const task of tasks) {
        if (task.endsWith('.md')) {
          await fs.copy(
            path.join(tasksSource, task),
            path.join(tasksDir, task),
            { overwrite: true }
          );
        }
      }
    }

    spinner.succeed('Claude Code: Agentes instalados');
  } catch (error) {
    spinner.fail('Erro ao instalar para Claude Code');
    throw error;
  }
}

/**
 * Install for Cursor IDE
 */
async installForCursor() {
  const spinner = ora('Instalando para Cursor...').start();

  try {
    const commandsDir = path.join(this.installPath, '.cursor', 'commands');
    const rulesDir = path.join(this.installPath, '.cursor', 'rules');

    await fs.ensureDir(commandsDir);
    await fs.ensureDir(rulesDir);

    // Gerar comandos usando o generator
    const generator = new CursorCommandGenerator();
    await generator.loadTemplates();

    for (const agentId of this.selectedAgents) {
      const commands = await generator.generateAgentCommands(agentId);

      for (const cmd of commands) {
        const targetPath = path.join(commandsDir, cmd.filename);
        await fs.writeFile(targetPath, cmd.content);
      }

      spinner.text = `Cursor: ${agentId} instalado`;
    }

    // Copiar regras globais
    const rulesTemplate = path.join(
      __dirname,
      '../../templates/cursor-rules-assistente-core.md'
    );
    const rulesTarget = path.join(rulesDir, 'assistente-core.md');

    await fs.copy(rulesTemplate, rulesTarget, { overwrite: true });

    spinner.succeed(`Cursor: ${this.selectedAgents.length} agentes instalados`);
  } catch (error) {
    spinner.fail('Erro ao instalar para Cursor');
    throw error;
  }
}
```

---

## CritÃ©rios de AceitaÃ§Ã£o

- [ ] `IDEDetector` detecta Claude Code corretamente
- [ ] `IDEDetector` detecta Cursor corretamente
- [ ] Prompt permite selecionar Claude Code, Cursor, ou ambos
- [ ] InstalaÃ§Ã£o em Claude Code cria `.claude/commands/assistentes/`
- [ ] InstalaÃ§Ã£o em Cursor cria `.cursor/commands/` (flat)
- [ ] InstalaÃ§Ã£o em Cursor cria `.cursor/rules/`
- [ ] InstalaÃ§Ã£o em ambos funciona simultaneamente
- [ ] Testes cobrem ambos os fluxos

---

**PrÃ³xima Story:** [6.3 - GeraÃ§Ã£o de Comandos Cursor](./6.3.story.md)
